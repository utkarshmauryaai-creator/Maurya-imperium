from fastapi import FastAPI, Request, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import httpx 
import logging 

app = FastAPI()

# --- ЁЯЫая╕П рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди ---
TOKEN = "8431876910:AAFW50pi2rNc66WkQtqGuj0Gc0KRlfIB9gU"
CHAT_ID = "7742066751"

# --- ЁЯФТ рд╕реБрд░рдХреНрд╖рд╛: рд╕рд┐рд░реНрдл рдЖрдкрдХрд╛ рдбреЛрдореЗрди (рдмрд┐рдирд╛ рдЖрдЦрд┐рд░реА '/') ---
ALLOWED_DOMAINS = [
    "https://019bb09b-e92f-7a55-a05a-684f63a13f4b.arena.site",
    "http://127.0.0.1:5500" # рд▓реЛрдХрд▓ рдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП
]

# --- ЁЯЫбя╕П CORS рд╕реЗрдЯрд┐рдВрдЧ ---
app.add_middleware(
    CORSMiddleware,
    allow_origins=ALLOWED_DOMAINS, # рд╕рд┐рд░реНрдл рдЖрдкрдХреА рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЛ рдЕрдиреБрдорддрд┐ рд╣реИ
    allow_methods=["GET", "POST", "OPTIONS"],
    allow_headers=["*"],
)

# рдЬрд╛рджреБрдИ рд░рд╛рд╕реНрддрд╛: рдпрд╣ / рдФрд░ /submit рджреЛрдиреЛрдВ рдХреЛ рд╕рдВрднрд╛рд▓ рд▓реЗрдЧрд╛
@app.api_route("/", methods=["GET", "POST"])
@app.api_route("/submit", methods=["GET", "POST"])
async def handle_any_form(request: Request):
    # рдЕрдЧрд░ рдХреЛрдИ рд╕рд┐рд░реНрдл рд▓рд┐рдВрдХ рдЦреЛрд▓рдХрд░ рджреЗрдЦреЗ
    if request.method == "GET":
        return {"status": "running", "message": "Domain Security Active"}

    try:
        # 1. рдбреЛрдореЗрди рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдБрдЪ (Origin Check)
        origin = request.headers.get("origin")
        if origin not in ALLOWED_DOMAINS:
            logging.warning(f"Blocked request from unknown domain: {origin}")
            return {"status": "error", "message": "Domain Not Allowed"}

        # 2. рдбреЗрдЯрд╛ рдЙрдард╛рдирд╛ (Form рдпрд╛ JSON)
        form_data = await request.form()
        data_to_send = dict(form_data) if form_data else {}
        
        if not data_to_send:
            try:
                data_to_send = await request.json()
            except:
                pass

        if not data_to_send:
            return {"status": "error", "message": "No data received"}

        # 3. рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рдореИрд╕реЗрдЬ рдбрд┐рдЬрд╛рдЗрди
        message_content = "ЁЯЪА **рдирдпрд╛ рдлреЙрд░реНрдо рд╕рдмрдорд┐рд╢рди!**\n"
        message_content += f"ЁЯМР **рд╡реЗрдмрд╕рд╛рдЗрдЯ:** {origin}\n"
        message_content += "тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ\n"

        for key, value in data_to_send.items():
            clean_key = key.replace("_", " ").title()
            message_content += f"ЁЯФ╣ **{clean_key}:** `{value}`\n"

        message_content += "тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ\n"
        message_content += "тП░ **рд╕рдордп:** Auto Logged"

        # 4. рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рдкрд░ рднреЗрдЬрдирд╛
        telegram_url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
        async with httpx.AsyncClient() as client:
            response = await client.post(telegram_url, data={
                "chat_id": CHAT_ID,
                "text": message_content,
                "parse_mode": "Markdown"
            }, timeout=10.0)
            
            if response.status_code == 200:
                return {"status": "success", "message": "Telegram par bhej diya gaya!"}
            else:
                return {"status": "error", "message": "Telegram API error"}

    except Exception as e:
        logging.error(f"Error: {str(e)}")
        return {"status": "error", "message": "Internal Server Error"}

# Render рд╣реЗрд▓реНрде рдЪреЗрдХ
@app.get("/health")
async def health_check():
    return {"status": "running"}

